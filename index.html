<html>
  <head>
    <meta charset="utf-8">
    <!-- encoding must be set for mocha's special characters to render properly -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/2.4.5/mocha.css" />
  </head>
  <body>
    <div id="mocha"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/2.4.5/mocha.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/should.js/8.1.1/should.js"></script>
    <script>
      mocha.ui('bdd')
    </script>

    <script src="./index.js"></script>

    <script>

      XHRShaper.useGlobal();

      var loaded, total;

      var xhr = new XMLHttpRequest();

      xhr.onreadystatechange = function(e) {
        console.log('readyState: ' + xhr.readyState);

        if (xhr.readyState === 4) {
          doneTime = Date.now();
          var duration = doneTime - reqTime;
          var bitrate = Math.round(8 * total / duration);
          console.log('Loaded ' + total + ' bytes in ' + duration + ' ms, computed bitrate: ' + bitrate + ' kbps');
        }
      };
      xhr.onprogress = function(e) {
        loaded = e.loaded;
        total = e.total;

        console.log('Progress: ' + e.loaded + ' of ' + e.total);
      };

      xhr.onload = function(e) {
        console.log('Loading done');
        //console.log(e);
      }

      xhr.onloadend = function(e) {
        console.log('Loading ended');
        //console.log(e);
      }

      xhr.withCredentials = false;
      xhr.open('GET', "http://www.streambox.fr/playlists/test_001/stream_110k_48k_416x234_000.ts", true);
      xhr.responseType = 'arraybuffer';

      xhr.shaper.minLatency = 1000;
      xhr.shaper.maxBandwidth = 512;

      console.debug('Max bandwidth: ' + xhr.shaper.maxBandwidth);
      console.debug('Min latency: ' + xhr.shaper.minLatency);

      var reqTime = Date.now(), doneTime;

      xhr.send();

    </script>

    <script>
      mocha.run();
    </script>
  </body>
</html>
